<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <title>BAPS Ravi Sabha Arusha</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Link to external CSS -->
  <link rel="stylesheet" href="style.css">
  <!-- Custom Font for premium look -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }

    /* Override font */
  </style>
</head>

<body>

  <script>
    // ==========================================
    // üöÄ PASTE YOUR GOOGLE SCRIPT WEB APP URL HERE
    // ==========================================
    const API_URL = "https://script.google.com/macros/s/AKfycbyt4dzD18S4WWturBxoYvrWzDTGEvrWCcgIvae9iuSjy6AJtBAi_fAPNciFaXFHD5Ee/exec";

    // State Variables
    let IS_ADMIN = false;
    let summaries = [];
    let dates = [];
    let rows = [];

  </script>

  <!-- LOADING INDICATOR -->
  <div id="loader"
    style="position:fixed;top:0;left:0;width:100%;height:100%;background:white;z-index:9999;display:flex;justify-content:center;align-items:center;flex-direction:column;gap:20px;">
    <img src="https://upload.wikimedia.org/wikipedia/en/4/4a/Baps_logo.svg" width="80"
      style="animation:pulse 1.5s infinite;">
    <div style="font-weight:600;color:#f59e0b;">BAPS TEMPLE ARUSHA...</div>
  </div>

  <style>
    @keyframes pulse {
      0% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.1);
      }

      100% {
        transform: scale(1);
      }
    }
  </style>


  <!-- TOP BAR -->
  <div class="topbar">
    <div class="home-area" onclick="showHome()">
      <img src="https://upload.wikimedia.org/wikipedia/en/4/4a/Baps_logo.svg" alt="BAPS Logo">
      <h1>BAPS RAVI SABHA ARUSHA</h1>
    </div>

    <!-- THEME TOGGLE BUTTON -->
    <button id="themeToggle" onclick="toggleTheme()" aria-label="Toggle Theme" style="
            background: rgba(255,255,255,0.2); 
            border: none; 
            width: 40px; 
            height: 40px; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            font-size: 20px; 
            margin-right: 10px;
            transition: all 0.3s ease;">
      üåô
    </button>

    <div id="menu"></div>
    <!-- Buttons moved to #menu -->
  </div>

  <script>
    // THEME LOGIC
    function toggleTheme() {
      document.body.classList.toggle('dark-mode');
      const isDark = document.body.classList.contains('dark-mode');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
      updateThemeIcon(isDark);
    }

    function updateThemeIcon(isDark) {
      const btn = document.getElementById('themeToggle');
      if (btn) {
        btn.innerHTML = isDark ? '‚òÄÔ∏è' : 'üåô';
        btn.style.background = isDark ? 'rgba(255,255,255,0.1)' : 'rgba(255,255,255,0.2)';
      }
    }

    // Initialize Theme
    (function () {
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme === 'dark') {
        document.body.classList.add('dark-mode');
        // We'll update icon in DOMContentLoaded or after body parses if this runs early
      }
    })();

    // Ensure icon is correct on load
    document.addEventListener("DOMContentLoaded", () => {
      const isDark = document.body.classList.contains('dark-mode');
      updateThemeIcon(isDark);
    });
  </script>

  <!-- SCHEDULE ACTION BAR (STICKY) -->
  <div id="scheduleActionBar">
    <input id="searchInput" type="text" placeholder="üîç Search by name" oninput="filterByName()"
      style="padding:10px 16px; border-radius:999px; border:none; outline:none; font-size:14px; width:220px;">
    <button onclick="saveAsPDF()"
      style="background:#065f46; color:white; padding:10px 20px; border:none; border-radius:999px; font-size:14px; font-weight:600; cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,.25);">
      <img src="https://drive.google.com/thumbnail?id=1r3R249nRRfndRX87iEHItbWiiGjWRaO4" style="height: 25px">Download
      as PDF
    </button>
  </div>

  <!-- VOLUNTEER HISTORY DRAWER -->
  <div id="drawerBackdrop" onclick="closeVolunteerDrawer()"></div>
  <div id="volunteerDrawer">
    <div class="drawer-header">
      <h2 id="drawerTitle">Volunteer History</h2>
      <button class="close-drawer-btn" onclick="closeVolunteerDrawer()">‚úï</button>
    </div>
    <div id="drawerContent">
      <!-- History items injected here -->
    </div>
  </div>

  <!-- ATTENDANCE ENTRY PAGE -->
  <div id="attendancePage" class="hidden">
    <!-- PASSWORD SCREEN -->
    <div id="attendanceLock" class="lock-card">
      <h2>üîí Attendance Access</h2>
      <input type="password" id="attendancePass" placeholder="Enter password">
      <button onclick="unlockAttendance()">Enter</button>
      <p id="attendanceError"></p>
    </div>

    <!-- MAIN CONTENT -->
    <div id="attendanceContent" class="hidden">
      <h2 class="page-title">Attendance Entry</h2>
      <!-- FORM -->
      <form id="attendanceForm">
        <input type="date" id="attDate" required>
        <input type="number" id="attGents" placeholder="Gents" required>
        <input type="number" id="attLadies" placeholder="Ladies" required>
        <input type="number" id="attChildren" placeholder="Children" required>
        <button type="submit">Save Attendance</button>
      </form>
      <!-- RESULT -->
      <div id="attendanceResult"></div>

      <!-- LOAD BALANCE -->
      <div id="attendanceLoadWrapper">
        <select id="monthSelect" onchange="onMonthFilterChange()"></select>
        <div id="dutyFilterBar" class="duty-filter hidden">
          <button onclick="setDutyFilter('pravachan')">Pravachan</button>
          <button onclick="setDutyFilter('kirtan')">Kirtan</button>
          <button onclick="setDutyFilter('emcee')">Emcee</button>
        </div>
        <div id="loadBalance" class="load-balance hidden"></div>
      </div>
    </div>
  </div>

  <!-- ATTENDANCE DASHBOARD -->
  <div id="dashboardSection" style="display:none;">
    <!-- DASHBOARD LOCK -->
    <div id="dashboardLock" class="lock-card">
      <h2>üìä Dashboard Access</h2>
      <input type="password" id="dashboardPass" placeholder="Enter password">
      <button onclick="unlockDashboard()">View Dashboard</button>
      <p id="dashboardError" style="text-align:center;margin-top:10px;"></p>
    </div>

    <!-- DASHBOARD CONTENT -->
    <div id="dashboardContent" class="hidden">
      <div class="dash-header">
        <h2 class="dash-title">Attendance Insights</h2>
        <div class="dash-subtitle">Real-time analysis of Ravi Sabha attendance</div>
      </div>

      <div class="stats-grid">
        <!-- Total Avg -->
        <div class="stat-card stat-total">
          <div class="stat-icon">üìä</div>
          <div class="stat-info">
            <h3>Avg. Total</h3>
            <span class="value" id="avgTotal">-</span>
          </div>
        </div>
        <!-- Gents -->
        <div class="stat-card stat-gents">
          <div class="stat-icon">üë®</div>
          <div class="stat-info">
            <h3>Avg. Gents</h3>
            <span class="value" id="avgGents">-</span>
          </div>
        </div>
        <!-- Ladies -->
        <div class="stat-card stat-ladies">
          <div class="stat-icon">üë©</div>
          <div class="stat-info">
            <h3>Avg. Ladies</h3>
            <span class="value" id="avgLadies">-</span>
          </div>
        </div>
        <!-- Children -->
        <div class="stat-card stat-children">
          <div class="stat-icon">üë∂</div>
          <div class="stat-info">
            <h3>Avg. Children</h3>
            <span class="value" id="avgChildren">-</span>
          </div>
        </div>
      </div>

      <div class="chart-container">
        <canvas id="attendanceChart"></canvas>
      </div>
    </div>
  </div>

  <!-- ACTIVITIES SECTION -->
  <div id="activitiesSection" style="display:none;">
    <div class="page-header">
      <h2 class="page-title">Our Activities</h2>
      <p class="page-subtitle">Join us in our spiritual journey through various sabhas customized for every age group.
      </p>
    </div>

    <div class="activities-grid">
      <!-- Injected via JS -->
    </div>
  </div>

  <!-- HOME SECTION -->
  <div id="homeSection">
    <img class="banner animate-hero"
      src="https://yt3.googleusercontent.com/K0FpCc1rgoypETYXlc1fZu5Npp602ZFqfnLSU9ppXGa8QugeatUcCWCWs5jf3Fyyg7MRl8H2=w1707-fcrop64=1,00005a57ffffa5a8-k-c0xffffffff-no-nd-rj">

    <!-- SUMMARY SECTION -->

    <!-- SCROLLYTELLING SECTION -->
    <div id="scrolly-section" style="height: 400vh; position: relative;">
      <div class="sticky-wrapper">
        <canvas id="scrolly-canvas"></canvas>

        <!-- Loader -->
        <div id="scrolly-loader">
          <div class="spinner"></div>
          <div class="loading-text">Loading Sequence...</div>
        </div>

        <!-- Overlays -->
        <div class="scrolly-overlay center" id="overlay-0">
          <div class="scrolly-text-content">
            <h2 class="scrolly-title">BAPS Temple</h2>
            <p class="scrolly-subtitle">Arusha, Tanzania</p>
          </div>
        </div>

        <div class="scrolly-overlay left" id="overlay-1">
          <div class="scrolly-text-content">
            <h2 class="scrolly-title">Grand Architecture</h2>
            <p class="scrolly-subtitle">Built with devotion and precision.</p>
          </div>
        </div>

        <div class="scrolly-overlay right" id="overlay-2">
          <div class="scrolly-text-content">
            <h2 class="scrolly-title">Spiritual Harmony</h2>
            <p class="scrolly-subtitle">A place of peace and reflection.</p>
          </div>
        </div>

        <div class="scrolly-overlay center" id="overlay-3">
          <div class="scrolly-text-content">
            <h2 class="scrolly-title">Welcome Home</h2>
            <p class="scrolly-subtitle">Experience the divinity.</p>
          </div>
        </div>
      </div>
    </div>

    <div class="summary-section animate-up delay-1">
      <div class="summary-title">Upcoming Events <img
          src="https://drive.google.com/thumbnail?id=1Gkrf_l8SDuIAEsVYcwn5VS_z_Ef_4khS" style="height: 25px"></div>
      <div class="summary-wrapper" id="summaryContainer">
        <!-- Injected via JS -->
      </div>
    </div>

    <div class="section">
      <div class="cards">
        <div class="info-card animate-up delay-2">
          <img src="https://drive.google.com/thumbnail?id=10ZU3rVQiVam2Q_zsmqY4h0PkC7g1UaNX">
          <p>
            BAPS Shri Swaminarayan Mandir in Arusha, Tanzania is a stunning Hindu temple.
            With its intricate carvings, peaceful atmosphere, and variety of facilities,
            it's a popular destination for visitors seeking a unique, enriching experience.
          </p>
        </div>
        <div class="info-card animate-up delay-3">
          <img src="https://www.baps.org/Data/Sites/1/Media/GalleryImages/5462/WebImages/pratishtha05f.jpg">
          <p>
            Nilkanth Varni inspired us to live a life of devotion, service, and self-improvement.
            Let us embody his virtues of compassion, kindness, and humility, and make a positive
            impact on the world.
          </p>
        </div>
        <div class="info-card animate-up delay-4">
          <img
            src="https://www.baps.org/Data/Sites/1/Media/GalleryImages/25999/WebImages/BAPS_Diwali_Annakut_Celebration_Arusha_09.jpg">
          <p>
            Akshar Purushottam Darshan is a Hindu philosophy that emphasizes devotion to God,
            ethical conduct, and pursuit of self-realization. Discover its transformative power.
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- SCHEDULE SECTION -->
  <div id="printHeader">
    <img src="https://upload.wikimedia.org/wikipedia/en/4/4a/Baps_logo.svg" alt="BAPS Logo">
    <div class="print-title">
      <h2>BAPS Ravi Sabha Programüìú Arusha</h2>
      <div id="printDate"></div>
    </div>
  </div>
  <div id="pdfBar" style="max-width:720px;margin:10px auto;text-align:right;"></div>

  <div id="scheduleSection"></div>

  <!-- PDF TABLE (PRINT ONLY) -->
  <table id="pdfTable" style="display:none;">
    <thead>
      <tr>
        <th>Start</th>
        <th>End</th>
        <th>Time‚åõ</th>
        <th>Duty‚òëÔ∏è</th>
        <th>Assigned Toüë§</th>
        <th>Detailsüî∞</th>
      </tr>
    </thead>
    <tbody id="pdfTableBody"></tbody>
  </table>
  <div id="pdfDuration" style="display:none; text-align:right; font-size:14px; margin-top:15px; padding-right:10px;">
  </div>

  <script>
    // =============================
    // üöÄ FETCH DATA (GITHUB MODE)
    // =============================

    document.addEventListener("DOMContentLoaded", () => {
      if (API_URL.includes("REPLACE")) {
        alert("‚ö†Ô∏è Please paste your Web App URL in index.html line 20!");
        document.getElementById("loader").style.display = "none";
        return;
      }

      fetch(API_URL)
        .then(res => res.json())
        .then(data => {
          // 1. Store Data
          summaries = data.summaries;
          dates = data.dates;
          rows = data.rows;
          const activities = data.activities || []; // New Data
          IS_ADMIN = data.isAdmin;

          // 2. Render UI
          renderSummaries();
          renderMenu();
          renderActivities(activities); // New Render Call

          // 3. Hide Loader
          document.getElementById("loader").style.display = "none";

          // Auto-Scroll
          const summaryWrapper = document.querySelector('.summary-wrapper');
          if (summaryWrapper) autoScrollSummary(summaryWrapper);
        })
        .catch(err => {
          console.error(err);
          document.getElementById("loader").innerHTML = "<div style='color:red'>‚ùå Error loading data<br>Check console</div>";
        });
    });


    // =========================================
    // üé≠ ACTIVITY CONTENT MAP
    // =========================================
    const ACTIVITY_METADATA = {
      "Ravi Sabha": {
        quote: "Discover inner peace and spiritual growth in a community of like-minded individuals.",
        desc: "Weekly assembly for adults to engage in satsang, listen to spiritual discourses, and perform devotion."
      },
      "Yuvak Sabha": {
        quote: "Balance your professional and spiritual life with guidance tailored for the modern youth.",
        desc: "A dynamic forum for young men to discuss challenges, find spiritual solutions, and perform seva."
      },
      "Yuvati Sabha": {
        quote: "Empowering young women through spirituality, culture, and unity.",
        desc: "A safe space for young women to grow spiritually, support each other, and celebrate culture."
      },
      "Kishore Sabha": {
        quote: "Navigate your teenage years with strong values, friendship, and fun.",
        desc: "Interactive sessions for teenage boys focusing on character building, education, and satsang."
      },
      "Kishori Sabha": {
        quote: "Inspiring teenage girls to lead a life of confidence and devotion.",
        desc: "Engaging activities and discussions for teenage girls to strengthen their bond with God and guru."
      },
      "Bal Sabha": {
        quote: "Nurture moral values and character through fun stories and games.",
        desc: "Fun-filled assembly for young boys with stories, games, and learning Hindu values."
      },
      "Balika Sabha": {
        quote: "Planting seeds of devotion and culture in young hearts.",
        desc: "Creative and educational sessions for young girls to learn about their heritage and faith."
      },
      "Gujarati Class": {
        quote: "Connect with your roots and learn the language of our culture.",
        desc: "Learn to read, write, and speak Gujarati, the language of our scriptures and satsang."
      }
    };

    // Old renderActivities removed to avoid duplicate

    function renderSummaries() {
      const summaryContainer = document.getElementById("summaryContainer");
      if (summaryContainer && summaries.length > 0) {
        const todayDate = new Date();
        todayDate.setHours(0, 0, 0, 0);

        const html = summaries.map(s => {
          const target = new Date(s.key);
          target.setHours(0, 0, 0, 0);
          const daysLeft = Math.ceil((target - todayDate) / (1000 * 60 * 60 * 24));
          const countdownHtml = (!s.isToday && daysLeft > 0)
            ? `<div class="countdown">${daysLeft} days left</div>`
            : "";

          return `
              <div class="summary-card" onclick="openFromSummary('${s.key}')">
                <img src="${s.pic}">
                <div class="summary-content">
                  <div class="summary-date">${s.label}
                  ${s.isToday ? "<span class='today-badge'>TODAY</span>" : ""}</div>
                  ${countdownHtml}
                  <div class="summary-text">${s.text}</div>
                </div>
              </div>
            `;
        }).join('');

        summaryContainer.innerHTML = html;
      }
    }


    let activeDutyType = "pravachan";
    let activeDateKey = null;
    const menu = document.getElementById("menu");
    const homeSection = document.getElementById("homeSection");
    const scheduleSection = document.getElementById("scheduleSection");
    const DUTY_GROUPS = {
      pravachan: ["Speech", "Pravachan"],
      kirtan: ["Kirtan"],
      emcee: ["Emcee"]
    };

    function renderScheduleFiltered(searchText = "") {
      if (!activeDateKey) return;

      const q = searchText.toLowerCase().trim();
      scheduleSection.innerHTML = "";
      let totalMinutes = 0;

      const pdfBody = document.getElementById("pdfTableBody");
      if (pdfBody) pdfBody.innerHTML = "";

      rows
        .filter(r => r.key === activeDateKey)
        .filter(r => !q || r.name.toLowerCase().includes(q))
        .forEach(r => {
          if (r.startTime && r.endTime) {
            const [sh, sm] = r.startTime.split(":").map(Number);
            const [eh, em] = r.endTime.split(":").map(Number);
            const start = new Date(); start.setHours(sh, sm, 0, 0);
            const end = new Date(); end.setHours(eh, em, 0, 0);
            const diffMinutes = (end - start) / (1000 * 60);
            if (!isNaN(diffMinutes) && diffMinutes > 0) totalMinutes += diffMinutes;
          }

          let html =
            `<div class='card'>
          <div class='card-header ${getDutyClass(r.task)}'>
            <span>${r.task}</span>
            ${r.pic ? `<img class='header-avatar' src='${r.pic}'>` : ""}
          </div>
          <div class='card-body'>
          ${(r.startTime && r.endTime) ?
              `<div class='time-range'>üïò <span>${r.startTime}</span> ‚Äì <span>${r.endTime}</span></div>` : ""
            }
            <div class='info-box'>
              <span class='icon'>üë§</span>
              <strong class="clickable-name" onclick="openVolunteerHistory('${r.name}')" title="View Duty History">${r.name}</strong>
            </div>
            ${r.details ?
              `<div class='info-box'>
                  <span class='icon'>üìù</span>
                  <div><b>Details</b><br>${r.details}</div>
                </div>` : ""
            }
            <div class='time-badge'>‚è± ${r.time}</div>
          </div>`;

          if (r.attachment) {
            html += `<div class='card-footer'><a class='download' href='${r.attachment}' target='_blank'>Download</a></div>`;
          }
          html += "</div>";
          scheduleSection.innerHTML += html;

          if (pdfBody) {
            pdfBody.innerHTML +=
              `<tr>
            <td>${r.startTime}</td>
            <td>${r.endTime}</td>
            <td>${r.time}</td>
            <td>${r.task}</td>
            <td>${r.name}</td>
            <td>${r.details || ""}</td>
          </tr>`;
          }
        });

      // Add Total Duration to PDF Table
      // Add Total Duration to PDF (Separate from table)
      const pdfDurationDiv = document.getElementById("pdfDuration");
      if (pdfDurationDiv) {
        const hours = Math.floor(totalMinutes / 60);
        const minutes = totalMinutes % 60;
        const durationText = (hours ? hours + " hr " : "") + minutes + " min";
        pdfDurationDiv.innerHTML = `<b>Total Program Duration:</b> ${durationText}`;
      }

      scheduleSection.innerHTML +=
        `<div class='total-duration'>
        üßÆ Total Program Duration: <b>${Math.floor(totalMinutes / 60) ? Math.floor(totalMinutes / 60) + " hr " : ""}${totalMinutes % 60} min</b>
      </div>`;
    }

    // =========================================
    // üö™ DRAWER LOGIC
    // =========================================
    function openVolunteerHistory(name) {
      if (!name) return;

      const drawer = document.getElementById("volunteerDrawer");
      const backdrop = document.getElementById("drawerBackdrop");
      const content = document.getElementById("drawerContent");
      const title = document.getElementById("drawerTitle");

      // 1. Find photo from any row associated with this person (prefer drawerPic from Col L)
      // Check if any row has drawerPic
      const userRow = rows.find(r => r.name.toLowerCase().trim() === name.toLowerCase().trim() && r.drawerPic);
      const userPic = userRow ? userRow.drawerPic : null;

      // Set Title with Image if available
      if (userPic) {
        title.innerHTML = `
          <div class="drawer-user-title">
            <img src="${userPic}" class="drawer-avatar">
            <span>${name}</span>
          </div>
        `;
      } else {
        title.innerText = `History: ${name}`;
      }

      content.innerHTML = ""; // Clear previous

      // 2. Filter Duties for this person
      const now = new Date();
      now.setHours(0, 0, 0, 0);

      const personDuties = rows
        .filter(r => r.name.trim().toLowerCase() === name.trim().toLowerCase())
        .filter(r => {
          // Parse r.key (assuming format YYYY-MM-DD or similar sortable logic from rows logic above)
          // Actually r.key seems to be date string based on previous usage. 
          // Let's rely on dates array to parse key if needed, or just new Date(r.key).
          const d = new Date(r.key);
          return d >= now;
        })
        .sort((a, b) => new Date(a.key) - new Date(b.key));

      if (personDuties.length === 0) {
        content.innerHTML = `<div style="text-align:center;color:#6b7280;margin-top:20px;">No upcoming duties found.</div>`;
      } else {
        personDuties.forEach((d, index) => {
          // delay animation slightly for each item
          const delay = index * 0.1;
          const dateLabel = dates.find(x => x.key === d.key)?.label || d.key;

          content.innerHTML += `
             <div class="history-card" style="animation-delay: ${delay}s">
               <div class="history-date">üìÖ ${dateLabel}</div>
               <div class="history-task">${d.task}</div>
               <div class="history-time">‚è∞ ${d.startTime} - ${d.endTime}</div>
               ${d.details ? `<div style="font-size:13px;margin-top:5px;color:#666;">${d.details}</div>` : ''}
             </div>
           `;
        });
      }

      // Show
      backdrop.classList.add("open");
      drawer.classList.add("open");
    }

    function closeVolunteerDrawer() {
      document.getElementById("volunteerDrawer").classList.remove("open");
      document.getElementById("drawerBackdrop").classList.remove("open");
    }


    function renderMenu() {
      menu.innerHTML = "";

      // 1. Scheduled Dropdown
      const dropdownWrapper = document.createElement("div");
      dropdownWrapper.className = "dropdown-wrapper";

      const scheduledBtn = document.createElement("button");
      scheduledBtn.innerHTML = "üìÖ Scheduled Sabha <span class='arrow'>‚ñº</span>";
      scheduledBtn.className = "action-btn scheduled-btn";
      scheduledBtn.onclick = (e) => {
        e.stopPropagation();
        toggleDropdown();
      };

      const dropdownContent = document.createElement("div");
      dropdownContent.className = "dropdown-content";
      dropdownContent.id = "dateDropdown";

      dates.forEach(d => {
        const item = document.createElement("div");
        item.className = "dropdown-item";
        item.textContent = d.label;
        item.onclick = () => {
          selectDate(d.key, scheduledBtn);
          // Highlight logic for dropdown items
          document.querySelectorAll('.dropdown-item').forEach(i => i.classList.remove('active'));
          item.classList.add('active');
        };
        dropdownContent.appendChild(item);
      });

      dropdownWrapper.appendChild(scheduledBtn);
      dropdownWrapper.appendChild(dropdownContent);
      menu.appendChild(dropdownWrapper);

      // 2. Dashboard Button
      const dashBtn = document.createElement("button");
      dashBtn.innerHTML = "üìä Dashboard";
      dashBtn.className = "action-btn dash-btn";
      dashBtn.onclick = openDashboard;
      menu.appendChild(dashBtn);

      // 3. Entry Button
      const entryBtn = document.createElement("button");
      entryBtn.innerHTML = "üìù Entry";
      entryBtn.className = "action-btn entry-btn";
      entryBtn.onclick = openAttendance;
      menu.appendChild(entryBtn);

      // 4. Activities Button (NEW)
      const activityBtn = document.createElement("button");
      activityBtn.innerHTML = "‚ú® Activities";
      activityBtn.className = "action-btn activity-btn";
      activityBtn.onclick = openActivities;
      menu.appendChild(activityBtn);

      // Click outside listener
      document.addEventListener('click', (e) => {
        if (!dropdownWrapper.contains(e.target)) {
          dropdownContent.classList.remove('show');
          scheduledBtn.classList.remove('open');
        }
      });
    }

    function toggleDropdown() {
      const content = document.getElementById("dateDropdown");
      const btn = document.querySelector(".scheduled-btn");

      const isShow = content.classList.contains("show");

      if (!isShow) {
        const rect = btn.getBoundingClientRect();
        content.style.position = 'fixed';
        content.style.top = (rect.bottom + 8) + 'px';
        content.style.left = rect.left + 'px';
        content.style.width = 'max-content'; // Ensure it fits content

        content.classList.add("show");
        btn.classList.add("open");
      } else {
        content.classList.remove("show");
        btn.classList.remove("open");
      }
    }

    // Close dropdown on scroll to prevent detached UI
    window.addEventListener('scroll', () => {
      const content = document.getElementById("dateDropdown");
      const btn = document.querySelector(".scheduled-btn");
      if (content && content.classList.contains("show")) {
        content.classList.remove("show");
        if (btn) btn.classList.remove("open");
      }
    });

    function selectDate(key, btn) {
      hideAllPages();
      activeDateKey = key;
      [...menu.children].forEach(b => b.classList.remove("active"));
      btn.classList.add("active");

      // SHOW SEARCH/PDF ONLY ON DATE PAGES
      document.getElementById("pdfBar").style.display = "block";
      const bar = document.getElementById("scheduleActionBar");
      bar.style.display = "flex";
      setTimeout(() => bar.classList.add("show"), 10);

      document.getElementById("printDate").innerText = "Date: " + dates.find(d => d.key === key).label;
      scheduleSection.style.display = "block";
      renderScheduleFiltered(); // First render
    }

    function filterByName() {
      const val = document.getElementById("searchInput").value;
      renderScheduleFiltered(val);
    }

    function showHome() {
      hideAllPages();
      document.getElementById("scheduleActionBar").style.display = "none";
      document.getElementById("pdfBar").style.display = "none";
      homeSection.style.display = "block";
      [...menu.children].forEach(b => b.classList.remove("active"));
    }

    function openActivities() {
      hideAllPages();
      document.getElementById("activitiesSection").style.display = "block";

      // HIDE SEARCH/PDF ON ACTIVITIES
      const bar = document.getElementById("scheduleActionBar");
      bar.classList.remove("show");
      bar.style.display = "none";
      document.getElementById("pdfBar").style.display = "none";

      // Highlight button
      const btns = [...menu.children];
      btns.forEach(b => b.classList.remove("active"));
      const actBtn = btns.find(b => b.innerHTML.includes("Activities"));
      if (actBtn) actBtn.classList.add("active");
    }

    function hideAllPages() {
      homeSection.style.display = "none";
      scheduleSection.style.display = "none";
      document.getElementById("attendancePage").classList.add("hidden");
      document.getElementById("dashboardSection").style.display = "none";
      document.getElementById("activitiesSection").style.display = "none";

      // Also hide attendance sub-elements
      document.getElementById("loadBalance").classList.add("hidden");
      document.getElementById("dutyFilterBar").classList.add("hidden");

      // Ensure specific elements are reset if needed
      document.getElementById("scheduleActionBar").classList.remove("show");
      document.getElementById("scheduleActionBar").style.display = "none";
    }

    function renderActivities(activities) {
      const container = document.querySelector(".activities-grid");
      if (!container) return;

      if (!activities || activities.length === 0) {
        container.innerHTML = "<p style='text-align:center;width:100%;color:#666;'>No activities found.</p>";
        return;
      }

      container.innerHTML = activities.map((act, index) => {
        // Trim name for better matching
        const cleanName = act.name ? act.name.trim() : "";
        const meta = ACTIVITY_METADATA[cleanName] || {};
        const quote = meta.quote || "";
        const desc = meta.desc || "";

        // Alternating Slow Motion Animations
        const animClass = (index % 2 === 0) ? "animate-left" : "animate-right";

        return `
          <div class="activity-card ${animClass}">
            <div class="activity-image">
              <img src="${act.pic || 'https://upload.wikimedia.org/wikipedia/en/4/4a/Baps_logo.svg'}" alt="${cleanName}">
              ${act.age ? `<div class="activity-tag">${act.age}</div>` : ''}
            </div>
            <div class="activity-content">
              <h3>${cleanName}</h3>
              <div class="activity-time">üóìÔ∏è ${act.day} @ ${act.time}</div>
              
              ${quote ? `<p class="activity-quote">"${quote}"</p>` : ''}
              ${desc ? `<p class="activity-desc">${desc}</p>` : ''}
              
              ${act.contact ? `<div class="activity-contact">üìû Contact: ${act.contact}</div>` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    function getDutyClass(task) {
      const t = task.toLowerCase();
      if (t.includes('emcee')) return 'emcee';
      if (t.includes('dhun')) return 'dhun';
      if (t.includes('prarth')) return 'prarthana';
      if (t.includes('speech')) return 'speech';
      if (t.includes('kirtan')) return 'kirtan';
      if (t.includes('aarti')) return 'aarti';
      if (t.includes('announcement')) return 'announcement';
      return 'default';
    }

    function saveAsPDF() { window.print(); }

    function openFromSummary(dateKey) {
      const buttons = [...menu.children];
      const btn = buttons.find(b => {
        return dates.find(d => d.key === dateKey && b.textContent === d.label);
      });
      if (!btn) return;
      selectDate(dateKey, btn);
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function renderLoadBalance(forceDateKey = null) {
      // Note: IS_ADMIN will likely be false in static mode unless we impl auth
      // if (!IS_ADMIN) return;

      const dateKeyToUse = forceDateKey || activeDateKey;
      if (!dateKeyToUse) return;

      const container = document.getElementById("loadBalance");
      container.innerHTML =
        "<h3>Volunteer Load Balance ‚Äì " +
        activeDutyType.charAt(0).toUpperCase() +
        activeDutyType.slice(1) +
        " (This Month)</h3>";

      const [year, month] = dateKeyToUse.split("-");
      const counts = {};

      const dutyKeywords = DUTY_GROUPS[activeDutyType];

      if (activeDutyType === "emcee") {
        const seen = {};
        rows.filter(r => r.key.startsWith(`${year}-${month}`))
          .filter(r => dutyKeywords.some(k => r.task.toLowerCase().includes(k.toLowerCase())))
          .forEach(r => {
            const name = r.name.trim();
            if (!seen[name]) seen[name] = new Set();
            seen[name].add(r.key);
          });
        Object.keys(seen).forEach(name => counts[name] = seen[name].size);
      } else {
        rows.filter(r => r.key.startsWith(`${year}-${month}`))
          .filter(r => dutyKeywords.some(k => r.task.toLowerCase().includes(k.toLowerCase())))
          .forEach(r => {
            const name = r.name.trim();
            counts[name] = (counts[name] || 0) + 1;
          });
      }

      if (Object.keys(counts).length === 0) {
        container.innerHTML += "<p style='text-align:center'>No duties in this category</p>";
        container.classList.remove("hidden");
        return;
      }

      const max = Math.max(...Object.values(counts));
      Object.entries(counts).sort((a, b) => b[1] - a[1]).forEach(([name, count]) => {
        const percent = (count / max) * 100;
        container.innerHTML +=
          `<div class='load-row'>
          <div class='load-name'>${name}</div>
          <div class='load-bar'><div class='load-fill' style='width:${percent}%'></div></div>
          <div class='load-count'>${count}</div>
        </div>`;
      });
      container.classList.remove("hidden");
    }

    function setDutyFilter(type) {
      activeDutyType = type;
      document.querySelectorAll(".duty-filter button").forEach(b => b.classList.remove("active"));
      event.target.classList.add("active");
      renderLoadBalance(null);
    }

    let attendanceUnlocked = false;
    function unlockAttendance() {
      const pass = document.getElementById("attendancePass").value;
      if (!pass) return;
      if (pass !== "kinpatel") {
        const err = document.getElementById("attendanceError");
        err.innerText = "‚ùå Incorrect Password";
        err.style.color = "red";
        err.style.fontWeight = "bold";
        return;
      }
      attendanceUnlocked = true;
      document.getElementById("attendanceLock").classList.add("hidden");
      document.getElementById("attendanceContent").classList.remove("hidden");
    }

    function openAttendance() {
      hideAllPages();
      document.getElementById("attendancePage").classList.remove("hidden");
      document.getElementById("dutyFilterBar").classList.remove("hidden");
      const lb = document.getElementById("loadBalance");
      lb.classList.remove("hidden");
      populateMonthDropdown();
    }

    document.getElementById("attendanceForm").addEventListener("submit", e => {
      e.preventDefault();

      const payload = {
        action: "saveAttendance",
        password: document.getElementById("attendancePass").value,
        data: {
          date: document.getElementById("attDate").value,
          gents: document.getElementById("attGents").value,
          ladies: document.getElementById("attLadies").value,
          children: document.getElementById("attChildren").value
        }
      };

      fetch(API_URL, {
        method: "POST",
        body: JSON.stringify(payload)
      })
        .then(res => res.json())
        .then(resp => {
          if (resp.success) {
            document.getElementById("attendanceResult").innerHTML = "<div class='success-card'>‚úÖ Attendance Saved</div>";
            document.getElementById("attendanceForm").reset();
          } else {
            throw new Error(resp.error || "Unknown Error");
          }
        })
        .catch(err => {
          document.getElementById("attendanceResult").innerHTML = "<div class='error-card'>‚ùå " + err.message + "</div>";
        });
    });

    function populateMonthDropdown() {
      const select = document.getElementById("monthSelect");
      select.innerHTML = "";
      const months = new Set();
      const today = new Date();
      const todayKey = today.getFullYear() + "-" + String(today.getMonth() + 1).padStart(2, '0');
      months.add(todayKey);

      rows.forEach(r => {
        if (!r.key) return;
        months.add(r.key.substring(0, 7));
      });

      Array.from(months).sort().reverse().forEach(mKey => {
        const [y, m] = mKey.split("-");
        const dateObj = new Date(parseInt(y), parseInt(m) - 1, 1);
        const label = dateObj.toLocaleString('default', { month: 'long', year: 'numeric' });
        const opt = document.createElement("option");
        opt.value = mKey;
        opt.textContent = label;
        if (mKey === todayKey) opt.selected = true;
        select.appendChild(opt);
      });
      onMonthFilterChange();
    }

    function onMonthFilterChange() {
      const val = document.getElementById("monthSelect").value;
      if (!val) return;
      activeDateKey = val + "-01"; // Generic first day for logic
      renderLoadBalance(activeDateKey);
    }

    // Old hideAllPages removed to avoid duplicate

    let chartInstance = null;
    let dashboardUnlocked = false;

    function openDashboard() {
      hideAllPages();
      document.getElementById("dashboardSection").style.display = "block";
      document.getElementById("scheduleActionBar").style.display = "none";
      document.getElementById("pdfBar").style.display = "none";
      [...menu.children].forEach(b => b.classList.remove("active"));

      if (!dashboardUnlocked) {
        document.getElementById("dashboardLock").classList.remove("hidden");
        document.getElementById("dashboardContent").classList.add("hidden");
        document.getElementById("dashboardPass").value = "";
        document.getElementById("dashboardError").innerText = "";
      } else {
        document.getElementById("dashboardLock").classList.add("hidden");
        document.getElementById("dashboardContent").classList.remove("hidden");
        showDashboardData();
      }
    }

    function unlockDashboard() {
      const pass = document.getElementById("dashboardPass").value;
      if (pass === "kinpatel") {
        dashboardUnlocked = true;
        document.getElementById("dashboardLock").classList.add("hidden");
        document.getElementById("dashboardContent").classList.remove("hidden");
        showDashboardData();
      } else {
        const err = document.getElementById("dashboardError");
        err.innerText = "‚ùå Incorrect Password";
        err.style.color = "red";
        err.style.fontWeight = "bold";
      }
    }

    function showDashboardData() {
      // Fetch specific action
      fetch(API_URL + "?action=getAttendance")
        .then(res => res.json())
        .then(data => {
          if (data.error) { console.error(data.error); return; }
          renderDashboard(data);
        });
    }

    function renderDashboard(data) {
      const avg = arr => arr.length ? Math.round(arr.reduce((a, b) => a + b, 0) / arr.length) : 0;

      document.getElementById('avgGents').innerText = avg(data.gents);
      document.getElementById('avgLadies').innerText = avg(data.ladies);
      document.getElementById('avgChildren').innerText = avg(data.children);

      const totalArr = data.gents.map((g, i) => g + data.ladies[i] + data.children[i]);
      document.getElementById('avgTotal').innerText = avg(totalArr);

      const ctx = document.getElementById('attendanceChart').getContext('2d');
      if (chartInstance) chartInstance.destroy();

      chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.labels,
          datasets: [
            { label: 'Gentsüë¶üèª', data: data.gents, backgroundColor: '#3b82f6', borderRadius: 4, stack: 'Stack 0' },
            { label: 'Ladiesüë©üèª', data: data.ladies, backgroundColor: '#ec4899', borderRadius: 4, stack: 'Stack 0' },
            { label: 'Childrenüë¶üèªüëßüèª', data: data.children, backgroundColor: '#f59e0b', borderRadius: 4, stack: 'Stack 0' }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'top' },
            tooltip: {
              mode: 'index', intersecting: false, backgroundColor: 'rgba(255,255,255,0.95)',
              titleColor: '#1e293b', bodyColor: '#475569', borderColor: '#e2e8f0', borderWidth: 1,
              callbacks: { footer: (items) => 'Total: ' + items.reduce((a, b) => a + b.raw, 0) }
            }
          },
          scales: {
            x: { stacked: true, grid: { display: false } },
            y: { stacked: true, beginAtZero: true, grid: { borderDash: [4, 4] } }
          }
        }
      });
    }

    function autoScrollSummary(wrapper) {
      let scrollSpeed = 0.5;
      let direction = 1;
      let isPaused = false;
      wrapper.addEventListener('mouseenter', () => isPaused = true);
      wrapper.addEventListener('mouseleave', () => isPaused = false);
      function step() {
        if (!isPaused) {
          wrapper.scrollLeft += scrollSpeed * direction;
          if (wrapper.scrollLeft + wrapper.clientWidth >= wrapper.scrollWidth) direction = -1;
          if (wrapper.scrollLeft <= 0) direction = 1;
        }
        requestAnimationFrame(step);
      }
      step();
    }

    // =========================================
    // üéûÔ∏è SCROLLYTELLING LOGIC
    // =========================================
    (function initScrolly() {
      const section = document.getElementById('scrolly-section');
      const canvas = document.getElementById('scrolly-canvas');
      const loader = document.getElementById('scrolly-loader');
      if (!section || !canvas) return;

      const context = canvas.getContext('2d');
      const frameCount = 192;
      const images = [];
      const frames = { current: 0 };

      // Define overlays with their active ranges (0.0 - 1.0 of scroll progress)
      // Adjust these ranges to match the "beats" from the prompt
      // 0% - Center
      // 25% - Left
      // 60% - Right
      // 90% - Center CTA
      const overlays = [
        { id: 'overlay-0', start: 0.0, end: 0.15 },
        { id: 'overlay-1', start: 0.20, end: 0.40 },
        { id: 'overlay-2', start: 0.55, end: 0.75 },
        { id: 'overlay-3', start: 0.85, end: 1.0 }
      ];

      // Resize Canvas
      function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        render(); // Re-render current frame on resize
      }
      window.addEventListener('resize', resizeCanvas);
      resizeCanvas();

      // Load Images
      // Actual naming: assets/sequence/00001.jpg
      let imagesLoaded = 0;

      const pad = (num, size) => {
        let s = num + "";
        while (s.length < size) s = "0" + s;
        return s;
      };

      for (let i = 0; i < frameCount; i++) {
        const img = new Image();
        // Files are 1-indexed (00001.jpg) and jpg format
        const fileName = pad(i + 1, 5) + ".jpg";
        img.src = `assets/sequence/${fileName}`;

        img.onload = () => {
          imagesLoaded++;
          if (imagesLoaded === frameCount) {
            loader.style.opacity = 0;
            setTimeout(() => loader.style.display = 'none', 500);
            render();
          }
        };
        img.onerror = () => {
          console.warn(`Failed to load frame: ${fileName}`);
          // If a frame fails, we still want to clear loader if mostly successful?
          // For now, let's just log. 
          // If specific important frames fail, user will see gaps.
        }
        images.push(img);
      }

      // Render Frame
      function render() {
        // Draw current frame
        const img = images[frames.current];
        if (img && img.complete) {
          // "Contain" fit logic
          const hRatio = canvas.width / img.width;
          const vRatio = canvas.height / img.height;

          // Fix: Use 'cover' (Math.max) for mobile to avoid vertical whitespace
          const isMobile = window.innerWidth < 768;
          const ratio = isMobile ? Math.max(hRatio, vRatio) : Math.min(hRatio, vRatio);

          const centerShift_x = (canvas.width - img.width * ratio) / 2;
          const centerShift_y = (canvas.height - img.height * ratio) / 2;

          context.clearRect(0, 0, canvas.width, canvas.height);
          context.drawImage(img,
            0, 0, img.width, img.height,
            centerShift_x, centerShift_y, img.width * ratio, img.height * ratio
          );
        }
      }

      // Scroll Handler
      window.addEventListener('scroll', () => {
        if (homeSection.style.display === 'none') return; // Don't run if not on home

        const sectionRect = section.getBoundingClientRect();
        const startY = sectionRect.top;
        const endY = sectionRect.bottom;
        const windowHeight = window.innerHeight;

        // Calculate progress 0 to 1
        // When section top is at 0 (sticky start), progress starts increasing
        // But we actually want progress relative to the scroll distance of the container
        // total scrollable distance = section.offsetHeight - windowHeight

        // We need to map the scroll position to [0, 1]
        // sticky wrapper stays fixed while section moves up

        // Calculate how far we are scrolled INTO the section
        // sectionRect.top is negative as we scroll down
        const scrollDistance = -sectionRect.top;
        const maxScroll = section.offsetHeight - windowHeight;

        let progress = scrollDistance / maxScroll;

        // Clamp 0 to 1
        progress = Math.max(0, Math.min(1, progress));

        // Map to frame
        const frameIndex = Math.min(
          frameCount - 1,
          Math.floor(progress * (frameCount - 1))
        );

        if (frameIndex !== frames.current) {
          frames.current = frameIndex;
          requestAnimationFrame(render);
        }

        // DEBUG: Uncomment to see values on screen
        /*
        let dbg = document.getElementById('debug-box');
        if(!dbg) {
             dbg = document.createElement('div');
             dbg.id = 'debug-box';
             dbg.style.position = 'fixed';
             dbg.style.top = '100px';
             dbg.style.left = '10px';
             dbg.style.background = 'rgba(0,0,0,0.8)';
             dbg.style.color = 'white';
             dbg.style.padding = '10px';
             dbg.style.zIndex = '9999';
             document.body.appendChild(dbg);
        }
        dbg.innerHTML = `
           Progress: ${progress.toFixed(3)}<br>
           Frame: ${frames.current}<br>
           Top: ${sectionRect.top.toFixed(0)}<br>
           H: ${section.offsetHeight}
        `;
        */

        // Handle Overlays
        overlays.forEach(overlay => {
          const el = document.getElementById(overlay.id);
          if (el) {
            // Simple fade in/out logic
            // If progress is within start/end, opacity 1, else 0
            // Add a small buffer for transition smoothness if needed
            if (progress >= overlay.start && progress <= overlay.end) {
              el.style.opacity = 1;
              el.style.transform = 'translateY(-50%) translateY(0px)';
            } else {
              el.style.opacity = 0;
              el.style.transform = 'translateY(-50%) translateY(20px)';
            }
          }
        });
      });

    })();

  </script>

</body>

</html>
