<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
<title>BAPS Ravi Sabha Arusha</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<link rel="stylesheet" href="Style.css">

</head>

<body>

<script>
    // ‚ö†Ô∏è REPLACE THIS URL AFTER DEPLOYING APPS SCRIPT AS WEB APP
    const API_URL = "https://script.google.com/macros/s/AKfycbzfeA_7t_-I5HsDKzy8WBdBqqM-9uOSFM8NsRogaickBYW4BSkgUdpsaFZC4hqIoj0g/exec";

    // Global Data Containers
    let dates = [];
    let rows = [];
    let summaries = [];
    let IS_ADMIN = false; // GitHub Pages version is public, Admin features hidden by default logic
  </script>

<!-- TOP BAR -->
<div class="topbar">
  <div class="home-area" onclick="showHome()">
    <img src="https://upload.wikimedia.org/wikipedia/en/4/4a/Baps_logo.svg">
    <h1>BAPS RAVI SABHA ARUSHA</h1>
  </div>
  <div id="menu"></div>
  <div class="nav-actions">
    <button class="dash-btn" onclick="openDashboard()">Dashboard</button>
    <button class="entry-btn" onclick="openAttendance()">Entry</button>
  </div>

</div>
<!-- SCHEDULE ACTION BAR (STICKY) -->
<div id="scheduleActionBar">
  <input
    id="searchInput"
    type="text"
    placeholder="üîç Search by name"
    oninput="filterByName()"
  >

  <button onclick="saveAsPDF()">
    üìÑ Download as PDF
  </button>
</div>
<div id="attendancePage" class="hidden">

  <!-- PASSWORD SCREEN -->
  <div id="attendanceLock" class="lock-card">
    <h2>üîí Attendance Access</h2>
    <input type="password" id="attendancePass" placeholder="Enter password">
    <button onclick="unlockAttendance()">Enter</button>
    <p id="attendanceError"></p>
  </div>

  <!-- MAIN CONTENT -->
  <div id="attendanceContent" class="hidden">
    
    <h2 class="page-title">Attendance Entry</h2>

    <!-- FORM -->
    <form id="attendanceForm">
      <input type="date" id="attDate" required>
      <input type="number" id="attGents" placeholder="Gents" required>
      <input type="number" id="attLadies" placeholder="Ladies" required>
      <input type="number" id="attChildren" placeholder="Children" required>

      <button type="submit">Save Attendance</button>
    </form>

    <!-- RESULT -->
    <div id="attendanceResult"></div>

    <!-- MOVED LOAD BALANCE HERE -->
    <div id="attendanceLoadWrapper">
        <select id="monthSelect" onchange="onMonthFilterChange()"></select>

        <div id="dutyFilterBar" class="duty-filter hidden">
          <button onclick="setDutyFilter('pravachan')">Pravachan</button>
          <button onclick="setDutyFilter('kirtan')">Kirtan</button>
          <button onclick="setDutyFilter('emcee')">Emcee</button>
        </div>
        <div id="loadBalance" class="load-balance hidden admin-only"></div>
    </div>

  </div>
</div>
</div>

<!-- ATTENDANCE DASHBOARD -->
<div id="dashboardSection" style="display:none;">

    <!-- DASHBOARD LOCK (Same style as attendance) -->
    <div id="dashboardLock" class="lock-card">
      <h2>üìä Dashboard Access</h2>
      <input type="password" id="dashboardPass" placeholder="Enter password">
      <button onclick="unlockDashboard()">View Dashboard</button>
      <p id="dashboardError" style="text-align:center;margin-top:10px;"></p>
    </div>

    <!-- DASHBOARD CONTENT (Hidden until unlocked) -->
    <div id="dashboardContent" class="hidden">
      <div class="dash-header">
        <h2 class="dash-title">Attendance Insights</h2>
        <div class="dash-subtitle">Real-time analysis of Ravi Sabha attendance</div>
    </div>

    <div class="stats-grid">
        <!-- Total Avg -->
        <div class="stat-card stat-total">
            <div class="stat-icon">üìä</div>
            <div class="stat-info">
                <h3>Avg. Total</h3>
                <span class="value" id="avgTotal">-</span>
            </div>
        </div>
        <!-- Gents -->
        <div class="stat-card stat-gents">
            <div class="stat-icon">üë®</div>
            <div class="stat-info">
                <h3>Avg. Gents</h3>
                <span class="value" id="avgGents">-</span>
            </div>
        </div>
        <!-- Ladies -->
        <div class="stat-card stat-ladies">
            <div class="stat-icon">üë©</div>
            <div class="stat-info">
                <h3>Avg. Ladies</h3>
                <span class="value" id="avgLadies">-</span>
            </div>
        </div>
        <!-- Children -->
        <div class="stat-card stat-children">
            <div class="stat-icon">üë∂</div>
            <div class="stat-info">
                <h3>Avg. Children</h3>
                <span class="value" id="avgChildren">-</span>
            </div>
        </div>
    </div>

    <div class="chart-container">
        <canvas id="attendanceChart"></canvas>
    </div>
    </div> <!-- End dashboardContent -->
</div>


<!-- HOME -->
<div id="homeSection">

  <img class="banner"
  src="https://yt3.googleusercontent.com/K0FpCc1rgoypETYXlc1fZu5Npp602ZFqfnLSU9ppXGa8QugeatUcCWCWs5jf3Fyyg7MRl8H2=w1707-fcrop64=1,00005a57ffffa5a8-k-c0xffffffff-no-nd-rj">
  <!-- ===== RAVI SABHA SUMMARY (NEW) ===== -->
<div class="summary-section">
  <div class="summary-title">Ravi Sabha Summary</div>

  <div class="summary-wrapper">
    ${summaries.map(s => `
      <div class="summary-card" onclick="openFromSummary('${s.key}')">
        <img src="${s.pic}">
        <div class="summary-content">
          <div class="summary-date">${s.label}
          ${s.isToday ? "<span class='today-badge'>TODAY</span>" : ""}</div>
          ${(() => {
  const today = new Date();
  today.setHours(0,0,0,0);

  const target = new Date(s.key);
  target.setHours(0,0,0,0);

  const daysLeft = Math.ceil((target - today) / (1000 * 60 * 60 * 24));

  return (!s.isToday && daysLeft > 0)
    ? `<div class="countdown">${daysLeft} days left</div>`
    : "";
})()}
          <div class="summary-text">${s.text}</div>
        </div>
      </div>
    `).join('')}
  </div>
</div>



  <div class="section">
    <div class="cards">

      <div class="info-card">
        <img src="https://www.baps.org/Data/Sites/1/Media/GalleryImages/25999/WebImages/BAPS_Diwali_Annakut_Celebration_Arusha_01.jpg">
        <p>
          BAPS Shri Swaminarayan Mandir in Arusha, Tanzania is a stunning Hindu temple.
          With its intricate carvings, peaceful atmosphere, and variety of facilities,
          it's a popular destination for visitors seeking a unique, enriching experience.
        </p>
      </div>

      <div class="info-card">
        <img src="https://drive.google.com/thumbnail?id=1vrUvmlSM098Ns86fLhENSnU6TXZAaVHl">
        <p>
          Nilkanth Varni inspired us to live a life of devotion, service, and self-improvement.
          Let us embody his virtues of compassion, kindness, and humility, and make a positive
          impact on the world.
        </p>
      </div>

      <div class="info-card">
        <img src="https://www.baps.org/Data/Sites/1/Media/GalleryImages/25999/WebImages/BAPS_Diwali_Annakut_Celebration_Arusha_09.jpg">
        <p>
          Akshar Purushottam Darshan is a Hindu philosophy that emphasizes devotion to God,
          ethical conduct, and pursuit of self-realization. Discover its transformative power.
        </p>
      </div>

    </div>
  </div>

</div>

<!-- SCHEDULE -->
<!-- PDF HEADER (VISIBLE ONLY IN PDF) -->
<div id="printHeader">
  <img
    src="https://upload.wikimedia.org/wikipedia/en/4/4a/Baps_logo.svg"
    alt="BAPS Logo"
  >
  <div class="print-title">
    <h2>BAPS Ravi Sabha Programüìú Arusha</h2>
    <div id="printDate"></div>
  </div>
</div>
<div id="pdfBar" style="max-width:720px;margin:10px auto;text-align:right;">
  
</div>

<div id="scheduleSection"></div>
<!-- REMOVED OLD FILTER BAR LOCATION -->
<!-- <div id="dutyFilterBar" class="duty-filter hidden">...</div> -->

<!-- VOLUNTEER LOAD BALANCE (REMOVED FROM HERE) -->
<!-- <div id="loadBalance" class="load-balance hidden admin-only"></div> -->
<!-- PDF TABLE (PRINT ONLY) -->
<table id="pdfTable" style="display:none;">
  <thead>
  <tr>
    <th>Start</th>
    <th>End</th>
    <th>Time</th>
    <th>Duty</th>
    <th>Assigned To</th>
    <th>Details</th>
  </tr>
</thead>
  <tbody id="pdfTableBody"></tbody>
</table>

<script>
if (IS_ADMIN) {
  document.querySelectorAll(".admin-only").forEach(el => {
    el.style.display = "block";
  });
}

let activeDutyType = "pravachan";
let activeDateKey = null;
const dates = ${JSON.stringify(dates)};
const rows = ${JSON.stringify(rows)};
const menu = document.getElementById("menu");
const homeSection = document.getElementById("homeSection");
const scheduleSection = document.getElementById("scheduleSection");
const DUTY_GROUPS = {
  pravachan: ["Speech", "Pravachan"],
  kirtan: ["Kirtan"],
  emcee: ["Emcee"]
};


function renderScheduleFiltered(searchText = ""){
  
  if (!activeDateKey) return;

  const q = searchText.toLowerCase().trim();
  scheduleSection.innerHTML = "";
  let totalMinutes = 0;
  
  // Prepare PDF table
  const pdfBody = document.getElementById("pdfTableBody");
  if (pdfBody) pdfBody.innerHTML = "";

  rows
    .filter(r => r.key === activeDateKey)
    .filter(r => !q || r.name.toLowerCase().includes(q))
    .forEach(r => {
    // ===== ADD DUTY DURATION TO TOTAL =====
if (r.startTime && r.endTime) {

  const [sh, sm] = r.startTime.split(":").map(Number);
  const [eh, em] = r.endTime.split(":").map(Number);

  const start = new Date();
  start.setHours(sh, sm, 0, 0);

  const end = new Date();
  end.setHours(eh, em, 0, 0);

  const diffMinutes = (end - start) / (1000 * 60);

  if (!isNaN(diffMinutes) && diffMinutes > 0) {
    totalMinutes += diffMinutes;
  }
}



      // ----- SCREEN CARD -----
      let html =
        "<div class='card'>" +

          "<div class='card-header " + getDutyClass(r.task) + "'>" +
            "<span>" + r.task + "</span>" +
            (r.pic ? "<img class='header-avatar' src='" + r.pic + "'>" : "") +
          "</div>" +

          "<div class='card-body'>" +
          (r.startTime && r.endTime
  ? "<div class='time-range'>üïò <span>" +
      r.startTime + "</span> ‚Äì <span>" + r.endTime +
    "</span></div>"
  : ""
) +


            "<div class='info-box'>" +
  "<span class='icon'>üë§</span>" +
  "<strong>" + r.name + "</strong>" +
"</div>"
 +

            (r.details
              ? "<div class='info-box'>" +
                  "<span class='icon'>üìù</span>" +
                  "<div><b>Details</b><br>" + r.details + "</div>" +
                "</div>"
              : ""
            ) +

            "<div class='time-badge'>‚è± " + r.time + "</div>" +

          "</div>";

      if (r.attachment) {
        html +=
          "<div class='card-footer'>" +
            "<a class='download' href='" + r.attachment + "' target='_blank'>Download</a>" +
          "</div>";
      }

      html += "</div>";
      scheduleSection.innerHTML += html;

      // ----- PDF TABLE -----
      if (pdfBody) {
        pdfBody.innerHTML +=
  "<tr>" +
    "<td>" + r.startTime + "</td>" +
    "<td>" + r.endTime + "</td>" +
    "<td>" + r.time + "</td>" +
    "<td>" + r.task + "</td>" +
    "<td>" + r.name + "</td>" +
    "<td>" + (r.details || "") + "</td>" +
  "</tr>";

      }
    });
    // ===== SHOW TOTAL PROGRAM DURATION =====
// ===== SHOW TOTAL PROGRAM DURATION =====
if (totalMinutes > 0) {
  const hours = Math.floor(totalMinutes / 60);
  const minutes = totalMinutes % 60;

  scheduleSection.innerHTML +=
    "<div class='total-duration'>" +
      "üßÆ Total Program Duration: <b>" +
      (hours ? hours + " hr " : "") +
      minutes + " min</b>" +
    "</div>";
}


}

function renderMenu(){
  dates.forEach(d=>{
    const b=document.createElement("button");
    b.textContent=d.label;
    b.onclick=()=>selectDate(d.key,b);
    menu.appendChild(b);
  });
}

function selectDate(key,btn){
  hideAllPages(); // üëà Reset all views first

  activeDateKey = key;
  [...menu.children].forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
  document.getElementById("pdfBar").style.display = "block";
  // Load Balance is HIDDEN in schedule view now
  // document.getElementById("dutyFilterBar").classList.add("hidden"); // Handled by hideAllPages
  const bar = document.getElementById("scheduleActionBar");
bar.style.display = "flex";

// allow DOM paint, then animate
setTimeout(() => {
  bar.classList.add("show");
}, 10);
  document.getElementById("printDate").innerText =
  "Date: " + dates.find(d => d.key === key).label;
  // homeSection.style.display="none"; // Handled by hideAllPages
  scheduleSection.style.display="block";
  scheduleSection.innerHTML="";
const pdfBody = document.getElementById("pdfTableBody");
pdfBody.innerHTML = "";
  rows.filter(r=>r.key===key).forEach(r=>{
    pdfBody.innerHTML +=
  "<tr>" +
    "<td>" + r.time + "</td>" +
    "<td>" + r.task + "</td>" +
    "<td>" + r.name + "</td>" +
    "<td>" + (r.details || "") + "</td>" +
  "</tr>";

    let html =
  "<div class='card'>" +

    /* ‚úÖ HEADER ‚Äî MUST STAY */
    "<div class='card-header " + getDutyClass(r.task) + "'>" +
  "<span>" + r.task + "</span>" +
  (r.pic
    ? "<img class='header-avatar' src='" + r.pic + "'>"
    : ""
  ) +
"</div>" +



    /* ‚úÖ BODY ‚Äî ENHANCED CONTENT */
    "<div class='card-body'>" +

      "<div class='info-box'>" +
       "<span class='icon'>üë§</span>" +
      "<strong>" + r.name + "</strong>" +
    "</div>" +

      (r.details
        ? "<div class='info-box'>" +
            "<span class='icon'>üìù</span>" +
            "<div><b>Details</b><br>" + r.details + "</div>" +
          "</div>"
        : ""
      ) +

      "<div class='time-badge'>‚è± " + r.time + "</div>" +

    "</div>";

/* ‚úÖ FOOTER (UNCHANGED) */
if (r.attachment) {
  html +=
    "<div class='card-footer'>" +
      "<a class='download' href='" + r.attachment + "' target='_blank'>Download</a>" +
    "</div>";
}

html += "</div>";

    scheduleSection.innerHTML += html;
    renderScheduleFiltered();
    // renderLoadBalance(); // Stop rendering load balance here


  });
}

function filterByName(){
  const val = document.getElementById("searchInput").value;
  renderScheduleFiltered(val);
}

function showHome(){
  hideAllPages(); // üëà Reset all views first
  
  document.getElementById("scheduleActionBar").style.display = "none";
  document.getElementById("pdfBar").style.display = "none";
  homeSection.style.display="block";
  [...menu.children].forEach(b=>b.classList.remove("active"));
}

renderMenu();
</script>
<script>
/* ===== AUTO SCROLL FOR SUMMARY ===== */
const summaryWrapper = document.querySelector('.summary-wrapper');

if (summaryWrapper) {
  let scrollSpeed = 0.5;     // speed
  let direction = 1;        // 1 = right, -1 = left
  let isPaused = false;

  summaryWrapper.addEventListener('mouseenter', () => isPaused = true);
  summaryWrapper.addEventListener('mouseleave', () => isPaused = false);

  function autoScrollSummary() {
    if (!isPaused) {
      summaryWrapper.scrollLeft += scrollSpeed * direction;

      // Reverse at edges
      if (
        summaryWrapper.scrollLeft + summaryWrapper.clientWidth >=
        summaryWrapper.scrollWidth
      ) {
        direction = -1;
      }

      if (summaryWrapper.scrollLeft <= 0) {
        direction = 1;
      }
    }
    requestAnimationFrame(autoScrollSummary);
  }

  autoScrollSummary();
}
function getDutyClass(task){
  const t = task.toLowerCase();

  if(t.includes('emcee')) return 'emcee';
  if(t.includes('dhun')) return 'dhun';
  if(t.includes('prarth')) return 'prarthana';
  if(t.includes('speech')) return 'speech';
  if(t.includes('kirtan')) return 'kirtan';
  if(t.includes('aarti')) return 'aarti';
  if(t.includes('announcement')) return 'announcement';

  return 'default';
}
function saveAsPDF(){
  window.print();
}
// Hide schedule action bar on initial load
const bar = document.getElementById("scheduleActionBar");
bar.classList.remove("show");

// wait for animation to finish, then hide
setTimeout(() => {
  bar.style.display = "none";
}, 300);
function openFromSummary(dateKey){

  // Find matching date button
  const buttons = [...menu.children];
  const btn = buttons.find(b => {
    return dates.find(d => d.key === dateKey && b.textContent === d.label);
  });

  if (!btn) return;

  // Trigger same behavior as clicking date button
  selectDate(dateKey, btn);

  // Scroll to top smoothly
  window.scrollTo({ top: 0, behavior: "smooth" });
}

function renderLoadBalance(forceDateKey = null){
  if (!IS_ADMIN) return;

  // Use passed key or active one
  const dateKeyToUse = forceDateKey || activeDateKey;
  if (!dateKeyToUse) return;

  const container = document.getElementById("loadBalance");
  container.innerHTML =
    "<h3>Volunteer Load Balance ‚Äì " +
    activeDutyType.charAt(0).toUpperCase() +
    activeDutyType.slice(1) +
    " (This Month)</h3>";

  const [year, month] = dateKeyToUse.split("-");
  const counts = {};

  rows
    .filter(r => {
      const [y, m] = r.key.split("-");
      return y === year && m === month;
    })
    .filter(r => {
      const keywords = DUTY_GROUPS[activeDutyType];
      return keywords.some(k =>
        r.task.toLowerCase().includes(k.toLowerCase())
      );
    })
    // üëá Special handling for EMCEE (unique per day)
if (activeDutyType === "emcee") {

  const seen = {}; // name -> Set of dates

  rows
    .filter(r => {
      const [y, m] = r.key.split("-");
      return y === year && m === month;
    })
    .filter(r => {
      const keywords = DUTY_GROUPS.emcee;
      return keywords.some(k =>
        r.task.toLowerCase().includes(k.toLowerCase())
      );
    })
    .forEach(r => {
      const name = r.name.trim();
      if (!seen[name]) seen[name] = new Set();
      seen[name].add(r.key); // üëà date key
    });

  Object.keys(seen).forEach(name => {
    counts[name] = seen[name].size; // üëà unique day count
  });

} else {

  // üëá existing logic for Pravachan / Kirtan
  rows
    .filter(r => {
      const [y, m] = r.key.split("-");
      return y === year && m === month;
    })
    .filter(r => {
      const keywords = DUTY_GROUPS[activeDutyType];
      return keywords.some(k =>
        r.task.toLowerCase().includes(k.toLowerCase())
      );
    })
    .forEach(r => {
      const name = r.name.trim();
      counts[name] = (counts[name] || 0) + 1;
    });
}



  if (Object.keys(counts).length === 0) {
    // If empty, show message but KEEP IT VISIBLE
    container.innerHTML +=
      "<p style='text-align:center'>No duties in this category</p>";
    container.classList.remove("hidden");
    return;
  }

  const max = Math.max(...Object.values(counts));

  Object.entries(counts)
    .sort((a,b) => b[1] - a[1])
    .forEach(([name, count]) => {

      const percent = (count / max) * 100;

      container.innerHTML +=
        "<div class='load-row'>" +
          "<div class='load-name'>" + name + "</div>" +
          "<div class='load-bar'>" +
            "<div class='load-fill' style='width:" + percent + "%'></div>" +
          "</div>" +
          "<div class='load-count'>" + count + "</div>" +
        "</div>";
    });

  container.classList.remove("hidden");
}

function setDutyFilter(type){

  activeDutyType = type;

  document
    .querySelectorAll(".duty-filter button")
    .forEach(b => b.classList.remove("active"));

  event.target.classList.add("active");

  renderLoadBalance(null);
}
let attendanceUnlocked = false;

function unlockAttendance(){
  const pass = document.getElementById("attendancePass").value;

  if (!pass) return;

  if (pass !== "baps123") {
      document.getElementById("attendanceError").innerText = "‚ùå Incorrect Password";
      document.getElementById("attendanceError").style.color = "red";
      document.getElementById("attendanceError").style.fontWeight = "bold";
      return;
  }

  attendanceUnlocked = true;
  document.getElementById("attendanceLock").classList.add("hidden");
  document.getElementById("attendanceContent").classList.remove("hidden");
}
function openAttendance(){
  console.log("Attendance button clicked");
  hideAllPages();
  document.getElementById("attendancePage").classList.remove("hidden");

  // Show Load Balance in Attendance View
  document.getElementById("dutyFilterBar").classList.remove("hidden");
  const lb = document.getElementById("loadBalance");
  lb.classList.remove("hidden");
  
  // Populate Month Dropdown & Render
  populateMonthDropdown();
}
document.getElementById("attendanceForm").addEventListener("submit", e => {
  e.preventDefault();

  const data = {
    date: document.getElementById("attDate").value,
    gents: document.getElementById("attGents").value,
    ladies: document.getElementById("attLadies").value,
    children: document.getElementById("attChildren").value
  };

  const password = document.getElementById("attendancePass").value;

  google.script.run
    .withSuccessHandler(() => {
      document.getElementById("attendanceResult").innerHTML =
        "<div class='success-card'>‚úÖ Attendance Saved</div>";
    })
    .withFailureHandler(err => {
      document.getElementById("attendanceResult").innerHTML =
        "<div class='error-card'>‚ùå " + err.message + "</div>";
    })
    .saveAttendance(data, password);
});

/* ===== MONTH FILTER LOGIC ===== */
function populateMonthDropdown() {
  const select = document.getElementById("monthSelect");
  select.innerHTML = "";

  // Get unique months from 'rows' (YYYY-MM)
  const months = new Set();
  const monthObjs = [];

  // Add Current Month as default option
  const today = new Date();
  // Client-side format: YYYY-MM
  const y = today.getFullYear();
  const m = String(today.getMonth() + 1).padStart(2, '0');
  const todayKey = y + "-" + m;
  
  months.add(todayKey);

  // Add months from data
  rows.forEach(r => {
    if(!r.key) return;
    const mKey = r.key.substring(0, 7); // yyyy-MM
    months.add(mKey);
  });

  // Convert to array and sort descending
  Array.from(months).sort().reverse().forEach(mKey => {
      monthObjs.push(mKey);
  });

  // Render options
  monthObjs.forEach(mKey => {
      const [y, m] = mKey.split("-");
      const dateObj = new Date(parseInt(y), parseInt(m)-1, 1);
      const label = dateObj.toLocaleString('default', { month: 'long', year: 'numeric' });
      
      const opt = document.createElement("option");
      opt.value = mKey;
      opt.textContent = label;
      if (mKey === todayKey) opt.selected = true;
      select.appendChild(opt);
  });

  // Trigger initial render
  onMonthFilterChange();
}

function onMonthFilterChange() {
  const select = document.getElementById("monthSelect");
  const val = select.value; // YYYY-MM
  if (!val) return;
  
  // Set activeDateKey to 1st of that month so logic works
  activeDateKey = val + "-01";
  renderLoadBalance(activeDateKey);
}

function hideAllPages(){
  homeSection.style.display = "none";
  scheduleSection.style.display = "none";
  document.getElementById("dashboardSection").style.display = "none";

  const att = document.getElementById("attendancePage");
  if (att) att.classList.add("hidden");
  
  // Hide load balance generally, specific views will unhide it
  document.getElementById("loadBalance").classList.add("hidden");
  document.getElementById("dutyFilterBar").classList.add("hidden");
}

let chartInstance = null;
let dashboardUnlocked = false;

// 1. Open Dashboard Wrapper (Lock Screen first)
function openDashboard() {
  hideAllPages(); // Utility to hide sections
  
  const sec = document.getElementById("dashboardSection");
  sec.style.display = "block";
  document.getElementById("scheduleActionBar").style.display = "none";
  document.getElementById("pdfBar").style.display = "none";
  [...menu.children].forEach(b => b.classList.remove("active"));
  
  // Reset lock if not unlocked
  if(!dashboardUnlocked) {
    document.getElementById("dashboardLock").classList.remove("hidden");
    document.getElementById("dashboardContent").classList.add("hidden");
    document.getElementById("dashboardPass").value = "";
    document.getElementById("dashboardError").innerText = "";
  } else {
    // Already unlocked? Show content directly
    document.getElementById("dashboardLock").classList.add("hidden");
    document.getElementById("dashboardContent").classList.remove("hidden");
    showDashboardData();
  }
}

// 2. Unlock Logic
function unlockDashboard() {
  const pass = document.getElementById("dashboardPass").value;
  if (pass === "baps123") {
    dashboardUnlocked = true;
    document.getElementById("dashboardLock").classList.add("hidden");
    document.getElementById("dashboardContent").classList.remove("hidden");
    showDashboardData();
  } else {
    const err = document.getElementById("dashboardError");
    err.innerText = "‚ùå Incorrect Password";
    err.style.color = "red";
    err.style.fontWeight = "bold";
  }
}

// 3. Fetch Data & Render
function showDashboardData() {
  google.script.run.withSuccessHandler(renderDashboard).getAttendanceData();
}

function renderDashboard(data) {
   if(data.error) {
     console.log("Error:", data.error);
     return;
   }
   
   // Calculate Averages
   const avg = arr => arr.length ? Math.round(arr.reduce((a,b) => a + b, 0) / arr.length) : 0;
   
   document.getElementById('avgGents').innerText = avg(data.gents);
   document.getElementById('avgLadies').innerText = avg(data.ladies);
   document.getElementById('avgChildren').innerText = avg(data.children);
   
   // Total Array for avg calculation
   const totalArr = data.gents.map((g, i) => g + data.ladies[i] + data.children[i]);
   document.getElementById('avgTotal').innerText = avg(totalArr);
   
   // CHART.JS RENDER (STACKED BAR)
   const ctx = document.getElementById('attendanceChart').getContext('2d');
   
   if(chartInstance) {
     chartInstance.destroy();
   }
   
   chartInstance = new Chart(ctx, {
     type: 'bar', // Changed to BAR
     data: {
       labels: data.labels,
       datasets: [
         {
           label: 'Gents',
           data: data.gents,
           backgroundColor: '#3b82f6',
           borderRadius: 4,
           stack: 'Stack 0'
         },
         {
           label: 'Ladies',
           data: data.ladies,
           backgroundColor: '#ec4899',
           borderRadius: 4,
           stack: 'Stack 0'
         },
         {
           label: 'Children',
           data: data.children,
           backgroundColor: '#f59e0b',
           borderRadius: 4,
           stack: 'Stack 0'
         }
       ]
     },
     options: {
       responsive: true,
       maintainAspectRatio: false,
       plugins: {
         legend: { position: 'top' },
         tooltip: {
           mode: 'index',
           intersect: false,
           backgroundColor: 'rgba(255, 255, 255, 0.95)',
           titleColor: '#1e293b',
           bodyColor: '#475569',
           borderColor: '#e2e8f0',
           borderWidth: 1,
           callbacks: {
             // Add Total to Tooltip
             footer: (tooltipItems) => {
               let sum = 0;
               tooltipItems.forEach(function(tooltipItem) {
                 sum += tooltipItem.raw;
               });
               return 'Total: ' + sum;
             }
           }
         }
       },
       scales: {
         x: {
           stacked: true, // Enable Stacking
           grid: { display: false }
         },
         y: {
           stacked: true, // Enable Stacking
           beginAtZero: true,
           grid: { borderDash: [4, 4] }
         }
       }
     }
   });
}


</script>

</body>
</html>

