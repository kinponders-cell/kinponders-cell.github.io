<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <title>BAPS Ravi Sabha Arusha</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="style.css">
</head>

<body>

  <script>
    // ‚ö†Ô∏è REPLACE THIS URL AFTER DEPLOYING APPS SCRIPT AS WEB APP
    const API_URL = "https://script.google.com/macros/s/AKfycbwxzIuwqA6LLUCMBk7AYNbT5AL9UCBqeoBHKpHIhT79NUUr9giq3FAAdefLjHG7if21/exec";

    // Global Data Containers
    let dates = [];
    let rows = [];
    let summaries = [];
    let IS_ADMIN = false; // GitHub Pages version is public, Admin features hidden by default logic
  </script>

  <!-- TOP BAR -->
  <div class="topbar">
    <div class="home-area" onclick="showHome()">
      <div class="logo-wrap">
        <img src="https://upload.wikimedia.org/wikipedia/en/4/4a/Baps_logo.svg">
      </div>
      <div>
        <h1 class="brand-title">BAPS RAVI SABHA</h1>
        <div style="font-size:12px;font-weight:600;color:#0f766e;opacity:0.8;margin-top:-2px;">ARUSHA</div>
      </div>
    </div>

    <div id="menu"></div>
    <!-- MOBILE DROPDOWN (Visible on small screens) -->
    <select id="mobileMenu" onchange="selectDate(this.value, null)"></select>

    <div class="nav-actions">
      <button class="dash-btn" onclick="openDashboard()">Dashboard</button>
      <button class="entry-btn" onclick="openAttendance()">Entry</button>
    </div>
  </div>

  <!-- SCHEDULE ACTION BAR (STICKY) -->
  <div id="scheduleActionBar">
    <input id="searchInput" type="text" placeholder="üîç Search by name" oninput="filterByName()">
    <button onclick="saveAsPDF()">
      üìÑ Download as PDF
    </button>
  </div>

  <div id="loadingOverlay"
    style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.9);z-index:9999;display:flex;justify-content:center;align-items:center;">
    <div style="text-align:center;">
      <div style="font-size:24px;margin-bottom:10px;">‚è≥ Loading...</div>
      <div style="color:#6b7280;">Please wait while we fetch the schedule.</div>
    </div>
  </div>

  <!-- ATTENDANCE PAGE -->
  <div id="attendancePage" class="hidden">
    <!-- PASSWORD SCREEN -->
    <div id="attendanceLock" class="lock-card">
      <h2>üîí Attendance Access</h2>
      <input type="password" id="attendancePass" placeholder="Enter password">
      <button onclick="unlockAttendance()">Enter</button>
      <p id="attendanceError"></p>
    </div>

    <!-- MAIN CONTENT -->
    <div id="attendanceContent" class="hidden">
      <h2 class="page-title">Attendance Entry</h2>
      <!-- FORM -->
      <form id="attendanceForm">
        <input type="date" id="attDate" required>
        <input type="number" id="attGents" placeholder="Gents" required>
        <input type="number" id="attLadies" placeholder="Ladies" required>
        <input type="number" id="attChildren" placeholder="Children" required>
        <button type="submit">Save Attendance</button>
      </form>
      <!-- RESULT -->
      <div id="attendanceResult"></div>
      <!-- LOAD BALANCE WRAPPER -->
      <div id="attendanceLoadWrapper">
        <select id="monthSelect" onchange="onMonthFilterChange()"></select>
        <div id="dutyFilterBar" class="duty-filter hidden">
          <button onclick="setDutyFilter('pravachan')">Pravachan</button>
          <button onclick="setDutyFilter('kirtan')">Kirtan</button>
          <button onclick="setDutyFilter('emcee')">Emcee</button>
        </div>
        <div id="loadBalance" class="load-balance hidden"></div>
      </div>
    </div>
  </div>

  <!-- ATTENDANCE DASHBOARD -->
  <div id="dashboardSection" style="display:none;">
    <!-- DASHBOARD LOCK -->
    <div id="dashboardLock" class="lock-card">
      <h2>üìä Dashboard Access</h2>
      <input type="password" id="dashboardPass" placeholder="Enter password">
      <button onclick="unlockDashboard()">View Dashboard</button>
      <p id="dashboardError" style="text-align:center;margin-top:10px;"></p>
    </div>

    <!-- DASHBOARD CONTENT -->
    <div id="dashboardContent" class="hidden">
      <div class="dash-header">
        <h2 class="dash-title">Attendance Insights</h2>
        <div class="dash-subtitle">Real-time analysis of Ravi Sabha attendance</div>
      </div>

      <div class="stats-grid">
        <div class="stat-card stat-total">
          <div class="stat-icon">üìä</div>
          <div class="stat-info">
            <h3>Avg. Total</h3>
            <span class="value" id="avgTotal">-</span>
          </div>
        </div>
        <div class="stat-card stat-gents">
          <div class="stat-icon">üë®</div>
          <div class="stat-info">
            <h3>Avg. Gents</h3>
            <span class="value" id="avgGents">-</span>
          </div>
        </div>
        <div class="stat-card stat-ladies">
          <div class="stat-icon">üë©</div>
          <div class="stat-info">
            <h3>Avg. Ladies</h3>
            <span class="value" id="avgLadies">-</span>
          </div>
        </div>
        <div class="stat-card stat-children">
          <div class="stat-icon">üë∂</div>
          <div class="stat-info">
            <h3>Avg. Children</h3>
            <span class="value" id="avgChildren">-</span>
          </div>
        </div>
      </div>

      <div class="chart-container">
        <canvas id="attendanceChart"></canvas>
      </div>
    </div>
  </div>

  <!-- HOME -->
  <div id="homeSection">

    <div class="hero-section">
      <div class="banner-container">
        <img class="banner-img"
          src="https://yt3.googleusercontent.com/K0FpCc1rgoypETYXlc1fZu5Npp602ZFqfnLSU9ppXGa8QugeatUcCWCWs5jf3Fyyg7MRl8H2=w1707-fcrop64=1,00005a57ffffa5a8-k-c0xffffffff-no-nd-rj">
      </div>
    </div>

    <!-- SUMMARY SECTION (Placeholder for dynamic content) -->
    <div class="summary-section">
      <div class="summary-title">Ravi Sabha Summary</div>
      <div class="summary-wrapper" id="summaryWrapperContainer">
        <!-- JS WILL INJECT SUMMARIES HERE -->
      </div>
    </div>

    <div class="section">
      <div class="info-card">
        <img
          src="https://www.baps.org/Data/Sites/1/Media/GalleryImages/25999/WebImages/BAPS_Diwali_Annakut_Celebration_Arusha_01.jpg">
        <p>
          BAPS Shri Swaminarayan Mandir in Arusha, Tanzania is a stunning Hindu temple.
          With its intricate carvings, peaceful atmosphere, and variety of facilities,
          it's a popular destination for visitors seeking a unique, enriching experience.
        </p>
      </div>
      <div class="info-card">
        <img src="https://drive.google.com/thumbnail?id=1vrUvmlSM098Ns86fLhENSnU6TXZAaVHl">
        <p>
          Nilkanth Varni inspired us to live a life of devotion, service, and self-improvement.
          Let us embody his virtues of compassion, kindness, and humility, and make a positive
          impact on the world.
        </p>
      </div>
      <div class="info-card">
        <img
          src="https://www.baps.org/Data/Sites/1/Media/GalleryImages/25999/WebImages/BAPS_Diwali_Annakut_Celebration_Arusha_09.jpg">
        <p>
          Akshar Purushottam Darshan is a Hindu philosophy that emphasizes devotion to God,
          ethical conduct, and pursuit of self-realization. Discover its transformative power.
        </p>
      </div>
    </div>
  </div>

  <!-- SCHEDULE -->
  <div id="scheduleSection"></div>

  <!-- PDF HEADER (VISIBLE ONLY IN PRINT) -->
  <div id="printHeader">
    <img src="https://upload.wikimedia.org/wikipedia/en/4/4a/Baps_logo.svg" alt="BAPS Logo">
    <div class="print-title">
      <h2>BAPS Ravi Sabha Programüìú Arusha</h2>
      <div id="printDate"></div>
    </div>
  </div>

  <table id="pdfTable" style="display:none;">
    <thead>
      <tr>
        <th>Start</th>
        <th>End</th>
        <th>Time</th>
        <th>Duty</th>
        <th>Assigned To</th>
        <th>Details</th>
      </tr>
    </thead>
    <tbody id="pdfTableBody"></tbody>
  </table>

  <script>
    // ===== FETCH DATA ON LOAD =====
    window.onload = async function () {
      if (API_URL === "YOUR_WEB_APP_URL_HERE") {
        alert("Please update API_URL in index.html with your deployed Web App URL.");
        return;
      }

      try {
        const response = await fetch(API_URL);
        const data = await response.json();

        dates = data.dates;
        rows = data.rows;
        summaries = data.summaries;

        initApp();
      } catch (err) {
        alert("Failed to load schedule data. " + err.message);
      } finally {
        document.getElementById("loadingOverlay").style.display = 'none';
      }
    };

    function initApp() {
      renderMenu();
      renderSummaries();
      // Animation setup
      const summaryWrapper = document.querySelector('.summary-wrapper');
      if (summaryWrapper) setupAutoScroll(summaryWrapper);
    }

    function renderSummaries() {
      const container = document.getElementById("summaryWrapperContainer");
      if (!container) return;

      const html = summaries.map(s => {
        let countdownHelpers = "";

        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const target = new Date(s.key);
        target.setHours(0, 0, 0, 0);
        const daysLeft = Math.ceil((target - today) / (1000 * 60 * 60 * 24));

        if (!s.isToday && daysLeft > 0) {
          countdownHelpers = `<div class="countdown">${daysLeft} days left</div>`;
        }

        return `
      <div class="summary-card" onclick="openFromSummary('${s.key}')">
        <img src="${s.pic}">
        <div class="summary-content">
          <div class="summary-date">${s.label}
          ${s.isToday ? "<span class='today-badge'>TODAY</span>" : ""}</div>
          ${countdownHelpers}
          <div class="summary-text">${s.text}</div>
        </div>
      </div>
    `;
      }).join('');

      container.innerHTML = html;
    }

    let activeDutyType = "pravachan";
    let activeDateKey = null;
    const menu = document.getElementById("menu");
    const homeSection = document.getElementById("homeSection");
    const scheduleSection = document.getElementById("scheduleSection");
    const DUTY_GROUPS = {
      pravachan: ["Speech", "Pravachan"],
      kirtan: ["Kirtan"],
      emcee: ["Emcee"]
    };

    function renderScheduleFiltered(searchText = "") {
      if (!activeDateKey) return;

      const q = searchText.toLowerCase().trim();
      scheduleSection.innerHTML = "";
      let totalMinutes = 0;

      const pdfBody = document.getElementById("pdfTableBody");
      if (pdfBody) pdfBody.innerHTML = "";

      rows
        .filter(r => r.key === activeDateKey)
        .filter(r => !q || r.name.toLowerCase().includes(q))
        .forEach(r => {
          // Duration Calc
          if (r.startTime && r.endTime) {
            const [sh, sm] = r.startTime.split(":").map(Number);
            const [eh, em] = r.endTime.split(":").map(Number);
            const start = new Date(); start.setHours(sh, sm, 0, 0);
            const end = new Date(); end.setHours(eh, em, 0, 0);
            const diffMinutes = (end - start) / (1000 * 60);
            if (!isNaN(diffMinutes) && diffMinutes > 0) totalMinutes += diffMinutes;
          }

          // Card HTML
          let html =
            "<div class='card'>" +
            "<div class='card-header " + getDutyClass(r.task) + "'>" +
            "<span>" + r.task + "</span>" +
            (r.pic ? "<img class='header-avatar' src='" + r.pic + "'>" : "") +
            "</div>" +
            "<div class='card-body'>" +
            (r.startTime && r.endTime
              ? "<div class='time-range'>üïò <span>" + r.startTime + "</span> ‚Äì <span>" + r.endTime + "</span></div>"
              : ""
            ) +
            "<div class='info-box'>" +
            "<span class='icon'>üë§</span>" +
            "<strong>" + r.name + "</strong>" +
            "</div>" +
            (r.details
              ? "<div class='info-box'><span class='icon'>üìù</span><div><b>Details</b><br>" + r.details + "</div></div>"
              : ""
            ) +
            "<div class='time-badge'>‚è± " + r.time + "</div>" +
            "</div>";

          if (r.attachment) {
            html += "<div class='card-footer'><a class='download' href='" + r.attachment + "' target='_blank'>Download</a></div>";
          }

          html += "</div>";
          scheduleSection.innerHTML += html;

          // PDF Table
          if (pdfBody) {
            pdfBody.innerHTML +=
              "<tr><td>" + r.startTime + "</td><td>" + r.endTime + "</td><td>" + r.time + "</td><td>" + r.task + "</td><td>" + r.name + "</td><td>" + (r.details || "") + "</td></tr>";
          }
        });

      if (totalMinutes > 0) {
        const hours = Math.floor(totalMinutes / 60);
        const minutes = totalMinutes % 60;

        // Create or find a dedicated container for duration outside the scheduled cards but inside the section
        let durationEl = document.getElementById("printDuration");
        if (!durationEl) {
          durationEl = document.createElement("div");
          durationEl.id = "printDuration";
          durationEl.className = "total-duration";
          scheduleSection.appendChild(durationEl);
        }

        durationEl.innerHTML = "üßÆ Total Program Duration: <b>" +
          (hours ? hours + " hr " : "") + minutes + " min</b>";

        // Re-append to ensure it's at the bottom
        scheduleSection.appendChild(durationEl);
      } else {
        const d = document.getElementById("printDuration");
        if (d) d.remove();
      </div >
    </div >

          function renderMenu() {
            menu.innerHTML = "";
            dates.forEach(d => {
              const b = document.createElement("button");
              b.textContent = d.label;
              b.onclick = () => selectDate(d.key, b);
              menu.appendChild(b);
            });

            // Mobile Dropdown Populate
            const mobileSel = document.getElementById("mobileMenu");
            mobileSel.innerHTML = "<option value='' disabled selected>üìÖ Select Date</option>";
            dates.forEach(d => {
              const opt = document.createElement("option");
              opt.value = d.key;
              opt.textContent = d.label;
              mobileSel.appendChild(opt);
            });
          }

        function selectDate(key, btn) {
          hideAllPages();
          activeDateKey = key;

          // Desktop Update
          [...menu.children].forEach(b => b.classList.remove("active"));
          if (btn) {
            btn.classList.add("active");
          } else {
            // Find button matching key if triggered from dropdown
            const matchingBtn = [...menu.children].find(b => b.textContent === dates.find(d => d.key === key).label);
            if (matchingBtn) matchingBtn.classList.add("active");
          }

          // Mobile Update
          document.getElementById("mobileMenu").value = key;

          const bar = document.getElementById("scheduleActionBar");
          bar.style.display = "flex";
          setTimeout(() => { bar.classList.add("show"); }, 10);

          document.getElementById("printDate").innerText = "Date: " + dates.find(d => d.key === key).label;
          scheduleSection.style.display = "block";

          renderScheduleFiltered();
        }

        function filterByName() {
          const val = document.getElementById("searchInput").value;
          renderScheduleFiltered(val);
        }

        function showHome() {
          hideAllPages();
          document.getElementById("scheduleActionBar").style.display = "none";
          homeSection.style.display = "block";
          [...menu.children].forEach(b => b.classList.remove("active"));
        }

        function setupAutoScroll(el) {
          let scrollSpeed = 0.5;
          let direction = 1;
          let isPaused = false;
          el.addEventListener('mouseenter', () => isPaused = true);
          el.addEventListener('mouseleave', () => isPaused = false);

          function loop() {
            if (!isPaused) {
              el.scrollLeft += scrollSpeed * direction;
              if (el.scrollLeft + el.clientWidth >= el.scrollWidth) direction = -1;
              if (el.scrollLeft <= 0) direction = 1;
            }
            requestAnimationFrame(loop);
          }
          loop();
        }

        function getDutyClass(task) {
          const t = task.toLowerCase();
          if (t.includes('emcee')) return 'emcee';
          if (t.includes('dhun')) return 'dhun';
          if (t.includes('prarth')) return 'prarthana';
          if (t.includes('speech')) return 'speech';
          if (t.includes('kirtan')) return 'kirtan';
          if (t.includes('aarti')) return 'aarti';
          if (t.includes('announcement')) return 'announcement';
          return 'default';
        }

        function saveAsPDF() { window.print(); }

        function openFromSummary(dateKey) {
          const buttons = [...menu.children];
          const btn = buttons.find(b => {
            return dates.find(d => d.key === dateKey && b.textContent === d.label);
          });
          if (!btn) return;
          selectDate(dateKey, btn);
          window.scrollTo({ top: 0, behavior: "smooth" });
        }

        // ===== LOAD BALANCE LOGIC =====
        function renderLoadBalance(forceDateKey = null) {
          // Admin only feature hidden in public view
          // To enable, we'd need admin password check for this too
          return;
        }

        function setDutyFilter(type) { /* Admin only */ }

        // ===== ATTENDANCE ENTRY LOGIC =====
        let attendanceUnlocked = false;

        function unlockAttendance() {
          const pass = document.getElementById("attendancePass").value;
          if (!pass) return;
          if (pass !== "baps123") {
            const err = document.getElementById("attendanceError");
            err.innerText = "‚ùå Incorrect Password";
            err.style.color = "red";
            err.style.fontWeight = "bold";
            return;
          }
          attendanceUnlocked = true;
          document.getElementById("attendanceLock").classList.add("hidden");
          document.getElementById("attendanceContent").classList.remove("hidden");
        }

        function openAttendance() {
          hideAllPages();
          document.getElementById("attendancePage").classList.remove("hidden");
          document.getElementById("dutyFilterBar").classList.remove("hidden");
          populateMonthDropdown();
        }

        document.getElementById("attendanceForm").addEventListener("submit", async e => {
          e.preventDefault();
          const form = document.getElementById("attendanceForm");
          const resultDiv = document.getElementById("attendanceResult");
          const saveBtn = form.querySelector("button");

          const data = {
            date: document.getElementById("attDate").value,
            gents: document.getElementById("attGents").value,
            ladies: document.getElementById("attLadies").value,
            children: document.getElementById("attChildren").value
          };
          const password = document.getElementById("attendancePass").value;

          saveBtn.disabled = true;
          saveBtn.innerText = "Saving...";

          try {
            const response = await fetch(API_URL, {
              method: "POST",
              body: JSON.stringify({ action: "saveAttendance", data, password })
            });
            const result = await response.json();

            if (result.status === "success") {
              resultDiv.innerHTML = "<div class='success-card'>‚úÖ Attendance Saved</div>";
            } else {
              resultDiv.innerHTML = "<div class='error-card'>‚ùå " + result.message + "</div>";
            }
          } catch (err) {
            resultDiv.innerHTML = "<div class='error-card'>‚ùå Network Error</div>";
          } finally {
            saveBtn.disabled = false;
            saveBtn.innerText = "Save Attendance";
          }
        });

        // Month Filter
        function populateMonthDropdown() {
          const select = document.getElementById("monthSelect");
          select.innerHTML = "";
          const uniqueMonths = new Set();
          const today = new Date();
          const m = String(today.getMonth() + 1).padStart(2, '0');
          const todayKey = today.getFullYear() + "-" + m;
          uniqueMonths.add(todayKey);

          rows.forEach(r => {
            if (!r.key) return;
            uniqueMonths.add(r.key.substring(0, 7));
          });

          Array.from(uniqueMonths).sort().reverse().forEach(mKey => {
            const [y, m] = mKey.split("-");
            const dateObj = new Date(parseInt(y), parseInt(m) - 1, 1);
            const label = dateObj.toLocaleString('default', { month: 'long', year: 'numeric' });
            const opt = document.createElement("option");
            opt.value = mKey;
            opt.textContent = label;
            if (mKey === todayKey) opt.selected = true;
            select.appendChild(opt);
          });
          onMonthFilterChange();
        }

        function onMonthFilterChange() {
          // Client side logic for load balance if needed
        }

        function hideAllPages() {
          homeSection.style.display = "none";
          scheduleSection.style.display = "none";
          document.getElementById("dashboardSection").style.display = "none";
          const att = document.getElementById("attendancePage");
          if (att) att.classList.add("hidden");
          const bar = document.getElementById("scheduleActionBar");
          if (bar) bar.style.display = "none";
        }

        // ===== DASHBOARD LOGIC =====
        let chartInstance = null;
        let dashboardUnlocked = false;

        function openDashboard() {
          hideAllPages();
          const sec = document.getElementById("dashboardSection");
          sec.style.display = "block";
          document.getElementById("scheduleActionBar").style.display = "none";
          [...menu.children].forEach(b => b.classList.remove("active"));

          if (!dashboardUnlocked) {
            document.getElementById("dashboardLock").classList.remove("hidden");
            document.getElementById("dashboardContent").classList.add("hidden");
            document.getElementById("dashboardPass").value = "";
            document.getElementById("dashboardError").innerText = "";
          } else {
            document.getElementById("dashboardLock").classList.add("hidden");
            document.getElementById("dashboardContent").classList.remove("hidden");
            showDashboardData();
          }
        }

        function unlockDashboard() {
          const pass = document.getElementById("dashboardPass").value;
          if (pass === "baps123") {
            dashboardUnlocked = true;
            document.getElementById("dashboardLock").classList.add("hidden");
            document.getElementById("dashboardContent").classList.remove("hidden");
            showDashboardData();
          } else {
            const err = document.getElementById("dashboardError");
            err.innerText = "‚ùå Incorrect Password";
            err.style.color = "red";
            err.style.fontWeight = "bold";
          }
        }

        async function showDashboardData() {
          try {
            const response = await fetch(API_URL + "?type=dashboard");
            const data = await response.json();
            renderDashboard(data);
          } catch (err) {
            console.error("Dashboard Error", err);
          }
        }

        function renderDashboard(data) {
          if (data.error) {
            console.log("Error:", data.error);
            return;
          }

          const avg = arr => arr.length ? Math.round(arr.reduce((a, b) => a + b, 0) / arr.length) : 0;

          document.getElementById('avgGents').innerText = avg(data.gents);
          document.getElementById('avgLadies').innerText = avg(data.ladies);
          document.getElementById('avgChildren').innerText = avg(data.children);

          const totalArr = data.gents.map((g, i) => g + data.ladies[i] + data.children[i]);
          document.getElementById('avgTotal').innerText = avg(totalArr);

          const ctx = document.getElementById('attendanceChart').getContext('2d');
          if (chartInstance) chartInstance.destroy();

          chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: data.labels,
              datasets: [
                { label: 'Gents', data: data.gents, backgroundColor: '#3b82f6', borderRadius: 4, stack: 'Stack 0' },
                { label: 'Ladies', data: data.ladies, backgroundColor: '#ec4899', borderRadius: 4, stack: 'Stack 0' },
                { label: 'Children', data: data.children, backgroundColor: '#f59e0b', borderRadius: 4, stack: 'Stack 0' }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { position: 'top' },
                tooltip: {
                  mode: 'index',
                  intersect: false,
                  callbacks: { footer: (tooltipItems) => 'Total: ' + tooltipItems.reduce((a, b) => a + b.raw, 0) }
                }
              },
              scales: {
                x: { stacked: true, grid: { display: false } },
                y: { stacked: true, beginAtZero: true, grid: { borderDash: [4, 4] } }
              }
            }
          });
        }
  </script>

</body>

</html>
